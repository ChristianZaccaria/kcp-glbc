# Custom Domain Support

Authors: Craig Brookes @maleck13

Epic: https://github.com/Kuadrant/kcp-glbc/issues/80

Date: 11th May 2022


## Job Stories

- As a developer, I want to use my own root domain for the APIs I expose so that I can provide my APIs under a well known and trusted root domain associated with my company


## Goals

- Ensure supporting custom domains is done in a safe way
- Enable using the GLBC managed domain as a CNAME on KCP registered clusters
- Allow sub domains of a custom root domain once the root domain is verified

## Non Goals

- Consider domain transfer and rechecking ownership once initial ownership has been verified
- Org level control over custom domains allowed beyond RBAC within a workspace.

## Current Approach

GLBC's default behaviour is to not allow the use of custom domain names. It assumes all workload clusters are shared by multiple untrusted tenants.


## Proposed Solution



The requirement is to prove ownership of a root domain before allowing it to be used within a namespace within a given workspace for ingress. To do this we will use DNS validation. This is the same process used for things like lets encrypt and GH pages. The assumption is that if you can make a change to the DNS Zone of a given domain, then you have control over where that domain resolves and so are considered the owner or at least authorised to use the domain.
 

Flow:

- End user creates a DomainVerification resource (outlined below)
- glbc always adds a token to the resource status based on the <org> and <workspace>
- Validating webhook ensures only GLBC service account can set this value
- End user takes the token provided in the DomainVerification resource and applies it as a txt record in their DNS Zone
- GLBC controller reconciles the resource and sets the status of the domain verification
- Validating webhook ensures only GLBC can set the status on this resource    
- End user creates / updates an Ingress object using the custom domain and potentially a new TLS section
- Validating webhook (for Ingress) checks the status of DomainVerification resource and allows or denies the change.    
- Both the GLBC host and the Custom Domain are synced to the physical cluser

To support this we will add a new workspace level API that will be exported by GLBC for use in end user workspaces. This API will be exposed at the workspace level (at some point potentially at the org level when that becomes supported):

```yaml 
apiVersion: kuadrant.dev/v1alpha1
kind: DomainVerification
metadata:
  name: my-domain
spec:
  domain: mydomain.com
status:
  token: <generated by controller webhook based on org and workspace># this value is protected by the validating webhook  
  conditions: # reflect the state of verification but are not used to prove verification
    - lastTransitionTime: "2019-10-22T16:29:24Z"
      status: "False"
      domain: mydomain.com
      message: "domain failed DNS verification"
      nextVerification: "2019-10-22T16:23:24Z"
      type: Verified  
    - lastTransitionTime: "2019-10-22T16:29:24Z"
      status: "True"
      domain: myotherdomain.com
      message: "domain successfully verified"
      nextVerification: "2019-10-22T16:29:24Z"
      type: Verified        
```

    
    
To verify ownership of the domain, we will provide a token that needs to be applied in a txt record to each of the listed domains ```glbc-verification=somevalue```. This value will be generated by the GLBC controller based on the org and workspace. 
A validating webhook for custom domain will ensure that this value is only modified by the service account associated with the GLBC controller. 
If for some reason the webhook is unavailable, we will configure a failure policy of ```fail``` https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#failure-policy    
The controller on reconcile will do a simple DNS validation equivalent to ``` dig domain txt ``` . The controller will update the status to reflect the current state of the verification. Once the status reaches a state of verified true, the controller will no longer do the DNS check. 
A validating webhook for Ingress will perform the following actions whenever an Ingress object is created or updated:

- check there is a DomainVerification resource for this domain within the targeted workspace (we will need to search for any match IE specific domain or subdomain). Example domain could be set to something.com but the Ingress is set to api.something.com
- Ensure the Verified  status condition type of the DomainVerification is set to true
- If not verfied reject with helpful error message



## Testing

We will want to design an e2e test for this feature however this will be complex as it involves checking a DNSRecord. We may want to look into something like local stack https://github.com/localstack/localstack


## Checklist

- [ x ] An epic has been created and linked to
- [ x ] Reviewers have been added. It is important that the right reviewers are selected. 